---
description: 'Work package task list for Volvox.Sober Recovery Platform implementation'
---

# Work Packages: Volvox.Sober Recovery Platform

**Inputs**: Design documents from `/kitty-specs/001-volvox-sober-recovery/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, contracts/, quickstart.md

**Tests**: Testing strategy follows constitution principles (TDD, 80% business logic coverage, 100% security paths).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/planned/` generated by `/spec-kitty.tasks`. Treat this file as the high-level checklist; keep deep implementation detail inside the prompt files.

## Subtask Format: `[Txxx] [P?] Description`

- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

## Path Conventions

**Mobile + API Architecture**:

- `mobile/src/` - React Native application code
- `mobile/__tests__/` - Mobile app tests
- `supabase/migrations/` - Database schema migrations
- `supabase/functions/` - Edge Functions (Deno)
- `shared/types/` - Shared TypeScript types

---

## Work Package WP01: Project Setup & Development Environment (Priority: P0)

**Goal**: Establish React Native mobile app and Supabase backend scaffolding with development tooling.
**Independent Test**: Project bootstraps locally with `npm run ios` and `npm run android`, Supabase runs locally, linting/formatting/typecheck passes.
**Prompt**: `/tasks/planned/WP01-project-setup-and-environment.md`

### Included Subtasks

- [ ] T001 Create root workspace and initialize package.json with workspaces configuration
- [ ] T002 [P] Initialize React Native 0.73+ project in `mobile/` with TypeScript 5.x template
- [ ] T003 [P] Initialize Supabase project with `supabase init` and configure `supabase/config.toml`
- [ ] T004 [P] Install mobile dependencies: React Navigation, React Native Paper, Redux Toolkit, RTK Query, AsyncStorage, Redux Persist
- [ ] T005 [P] Configure ESLint and Prettier for TypeScript (mobile and functions)
- [ ] T006 [P] Configure TypeScript `tsconfig.json` for mobile app with React Native presets
- [ ] T007 [P] Setup Jest and React Native Testing Library in `mobile/__tests__/`
- [ ] T008 [P] Configure Detox for E2E testing (iOS and Android)
- [ ] T009 Create shared types directory `shared/types/` with initial entity type definitions
- [ ] T010 Setup Firebase Cloud Messaging (FCM) configuration for iOS and Android
- [ ] T011 [P] Configure React Native Paper theme with light/dark mode support
- [ ] T012 Document local development setup in quickstart.md (verify matches template)
- [ ] T013 Create `.env.example` files for mobile and Supabase with required environment variables

### Implementation Notes

- Use `npx create-expo-app` or `npx react-native init` for mobile project initialization
- Supabase local development requires Docker (for PostgreSQL, Realtime, Storage)
- Pin all dependency versions in package.json for reproducibility
- Configure pre-commit hooks for linting and formatting (husky + lint-staged)
- iOS requires Xcode 14+ and CocoaPods; Android requires Android Studio with SDK 26+

### Parallel Opportunities

- Mobile app initialization (T002) and Supabase setup (T003) can proceed in parallel
- All dependency installation tasks (T004-T008) can run concurrently after project init
- Theme configuration (T011) and Firebase setup (T010) are independent

### Dependencies

- None (starting package)

### Risks & Mitigations

- **Risk**: React Native version compatibility with libraries
  - **Mitigation**: Use React Native 0.73 stable, verify all library compatibility before installation
- **Risk**: Detox setup complexity across platforms
  - **Mitigation**: Follow official Detox React Native guide, test on both iOS simulator and Android emulator early

---

## Work Package WP02: Database Schema & Authentication Foundation (Priority: P0)

**Goal**: Implement complete PostgreSQL schema with RLS policies and Supabase Auth integration.
**Independent Test**: All migrations apply successfully, RLS policies block unauthorized access (automated tests), users can signup/login via Supabase Auth.
**Prompt**: `/tasks/planned/WP02-database-schema-and-auth-foundation.md`

### Included Subtasks

- [ ] T014 Create initial migration: users table with role, profile fields, and timestamps
- [ ] T015 [P] Create migration: sponsor_profiles and sponsee_profiles tables
- [ ] T016 [P] Create migration: sobriety_dates and relapses tables with calculated fields
- [ ] T017 [P] Create migration: connection_requests, connections, matches tables
- [ ] T018 [P] Create migration: steps (reference data), step_work tables
- [ ] T019 [P] Create migration: messages, checkins, checkin_responses tables
- [ ] T020 [P] Create migration: notifications table
- [ ] T021 Create all RLS policies for users, sponsor_profiles, sponsee_profiles tables
- [ ] T022 [P] Create RLS policies for sobriety_dates, relapses (with mutual visibility logic)
- [ ] T023 [P] Create RLS policies for connection_requests, connections, matches
- [ ] T024 [P] Create RLS policies for steps, step_work (read-only reference data + sponsee access)
- [ ] T025 [P] Create RLS policies for messages, checkins, checkin_responses
- [ ] T026 [P] Create RLS policies for notifications
- [ ] T027 Create database triggers: update_updated_at_column for all tables with updated_at
- [ ] T028 [P] Create trigger: notify_new_message for Realtime subscriptions
- [ ] T029 [P] Create trigger: update_connection_last_contact for message tracking
- [ ] T030 [P] Create trigger: update_sponsor_capacity on connection status changes
- [ ] T031 Create indexes on users (email, location GIST, role)
- [ ] T032 [P] Create indexes on sponsor_profiles (capacity), sponsee_profiles (user_id)
- [ ] T033 [P] Create indexes on sobriety_dates, relapses (user_id, active)
- [ ] T034 [P] Create indexes on connection_requests, connections (sponsor_id, sponsee_id, status)
- [ ] T035 [P] Create indexes on messages (connection_id, recipient_id for unread counts)
- [ ] T036 [P] Create indexes on checkins, checkin_responses
- [ ] T037 [P] Create indexes on notifications (user_id, read_at)
- [ ] T038 Create seed data: 12 AA steps with default questions in steps table
- [ ] T039 Implement Supabase client configuration in `mobile/src/services/supabase.ts`
- [ ] T040 [P] Setup Redux store in `mobile/src/store/` with RTK Query API base
- [ ] T041 Create authentication API slice in `mobile/src/store/api/authApi.ts` (signup, login, logout, password reset)
- [ ] T042 Create auth screens: Login, Signup, Email Verification, Password Reset in `mobile/src/screens/auth/`
- [ ] T043 [P] Implement secure token storage using AsyncStorage with encryption
- [ ] T044 Write RLS policy tests in `supabase/tests/` attempting unauthorized access (use Supabase test helpers)

### Implementation Notes

- Follow data-model.md exactly for schema definitions
- Enable RLS on all tables immediately after creation: `ALTER TABLE table_name ENABLE ROW LEVEL SECURITY;`
- Use `auth.uid()` in RLS policies to reference authenticated user
- Seed data script: `supabase/seed.sql` with AA 12 steps
- Supabase Auth handles password hashing, email verification, JWT tokens automatically
- Store Supabase URL and anon key in environment variables, never in code

### Parallel Opportunities

- All migration files (T014-T020) can be created concurrently, but apply sequentially
- RLS policy creation (T021-T026) can be written in parallel after migrations
- Trigger creation (T027-T030) can be implemented concurrently
- Index creation (T031-T037) can all run in parallel after schema is complete
- Mobile auth implementation (T039-T043) can proceed while database work completes

### Dependencies

- Depends on WP01 (project setup complete)

### Risks & Mitigations

- **Risk**: RLS policy bugs allowing unauthorized data access
  - **Mitigation**: Write automated tests for every RLS policy attempting unauthorized access (T044)
- **Risk**: Migration conflicts if applied out of order
  - **Mitigation**: Use Supabase CLI migration timestamps, apply migrations sequentially in CI/CD
- **Risk**: Performance issues with complex RLS policies
  - **Mitigation**: Index foreign keys heavily, use EXPLAIN ANALYZE on complex queries

---

## Work Package WP03: User Onboarding & Profile Management (Priority: P1) ðŸ”§ Foundation

**Goal**: Implement complete user onboarding flow (role selection, profile creation, preference setup) for both sponsors and sponsees.
**Independent Test**: New users can signup, choose role, complete profile with all required fields, and reach dashboard. Profile data persists and can be edited.
**Prompt**: `/tasks/planned/WP03-user-onboarding-and-profile-management.md`

### Included Subtasks

- [ ] T045 Create onboarding navigation flow in `mobile/src/navigation/OnboardingNavigator.tsx`
- [ ] T046 Implement role selection screen in `mobile/src/screens/onboarding/RoleSelectionScreen.tsx` (Sponsor, Sponsee, Both)
- [ ] T047 [P] Create profile form screen in `mobile/src/screens/onboarding/ProfileFormScreen.tsx` (name, age, gender, location, bio, profile photo)
- [ ] T048 [P] Create sponsee preferences screen in `mobile/src/screens/onboarding/SponseePreferencesScreen.tsx` (preferred sponsor criteria)
- [ ] T049 [P] Create sponsor preferences screen in `mobile/src/screens/onboarding/SponsorPreferencesScreen.tsx` (capacity, communication frequency, matching preferences)
- [ ] T050 [P] Create sobriety date input screen in `mobile/src/screens/onboarding/SobrietyDateScreen.tsx` (substance type, start date)
- [ ] T051 Implement user profile API slice in `mobile/src/store/api/userApi.ts` (createProfile, updateProfile, getProfile)
- [ ] T052 [P] Implement sponsor profile API slice in `mobile/src/store/api/sponsorApi.ts` (createSponsorProfile, updateSponsorProfile)
- [ ] T053 [P] Implement sponsee profile API slice in `mobile/src/store/api/sponseeApi.ts` (createSponseeProfile, updateSponseeProfile)
- [ ] T054 Implement sobriety date API slice in `mobile/src/store/api/sobrietyApi.ts` (addSobrietyDate, updateSobrietyDate, getSobrietyDates)
- [ ] T055 Create profile editing screen in `mobile/src/screens/profile/EditProfileScreen.tsx` (reuse onboarding form components)
- [ ] T056 [P] Create profile photo upload component using Supabase Storage in `mobile/src/components/profile/ProfilePhotoUpload.tsx`
- [ ] T057 [P] Create location picker component with map in `mobile/src/components/common/LocationPicker.tsx` (use react-native-maps)
- [ ] T058 Implement Redux slice for onboarding state in `mobile/src/store/slices/onboardingSlice.ts` (track completion steps)
- [ ] T059 Create shared profile types in `shared/types/entities/user.ts`, `shared/types/entities/profile.ts`

### Implementation Notes

- Onboarding must collect all required fields before allowing user to proceed to dashboard
- Use multi-step wizard pattern with progress indicator
- Validate all form inputs before submission (email format, age range, required fields)
- Profile photo upload to Supabase Storage bucket `profile-photos` with RLS policy restricting to user's own photos
- Location picker should store both coordinates (for matching) and city name (for display)
- Use React Native Paper form components for consistent UI

### Parallel Opportunities

- All screen implementations (T046-T050) can be built in parallel after navigation setup (T045)
- All API slices (T051-T054) can be created concurrently
- Profile photo component (T056) and location picker (T057) can be built independently

### Dependencies

- Depends on WP02 (database schema and auth foundation)

### Risks & Mitigations

- **Risk**: Incomplete profile data causing downstream errors
  - **Mitigation**: Enforce required fields at database level (NOT NULL constraints) and validate in forms
- **Risk**: Profile photo upload failures
  - **Mitigation**: Implement retry logic, allow users to skip photo and add later

---

## Work Package WP04: Matching Algorithm & Match Display (Priority: P1) ðŸŽ¯ MVP Core

**Goal**: Implement weighted scoring matching algorithm as Supabase Edge Function and display sponsor matches to sponsees.
**Independent Test**: Sponsee can request matches and receive 3-5 ranked sponsors with compatibility scores and reasons. Matches are relevant and meet preference criteria.
**Prompt**: `/tasks/planned/WP04-matching-algorithm-and-match-display.md`

### Included Subtasks

- [ ] T060 Create matching algorithm Edge Function in `supabase/functions/matching-algorithm/index.ts`
- [ ] T061 Implement geographic proximity scoring (25 points max, Haversine distance calculation)
- [ ] T062 [P] Implement sobriety time alignment scoring (25 points max, sponsor vs sponsee timeline compatibility)
- [ ] T063 [P] Implement communication preference alignment scoring (20 points max, frequency and style matching)
- [ ] T064 [P] Implement demographic preference scoring (15 points max, gender, age preferences)
- [ ] T065 [P] Implement sponsor availability scoring (15 points max, capacity and status)
- [ ] T066 Generate compatibility reasons array (e.g., "Nearby location (12 miles)", "Similar recovery timeline")
- [ ] T067 Cache match results in matches table with timestamp
- [ ] T068 Implement match invalidation on sponsor profile update
- [ ] T069 Create matching API slice in `mobile/src/store/api/matchingApi.ts` (requestMatches, getMatches)
- [ ] T070 Implement matches screen in `mobile/src/screens/matching/MatchesScreen.tsx` (list of sponsor cards)
- [ ] T071 [P] Create sponsor match card component in `mobile/src/components/matching/SponsorMatchCard.tsx` (photo, name, score, reasons)
- [ ] T072 [P] Create sponsor profile detail screen in `mobile/src/screens/matching/SponsorProfileScreen.tsx` (full profile, bio, send request button)
- [ ] T073 Implement match refresh logic (pull-to-refresh and automatic refresh when new sponsors join)
- [ ] T074 Add loading states and empty states for matches screen

### Implementation Notes

- Matching algorithm runs server-side in Edge Function to prevent client-side manipulation
- Use Supabase Deno runtime with TypeScript for Edge Functions
- Haversine formula for geographic distance: `acos(sin(lat1) * sin(lat2) + cos(lat1) * cos(lat2) * cos(lon2 - lon1)) * 6371` (km)
- Sobriety alignment: sponsors should have â‰¥ 2x sponsee's sobriety time for mentorship credibility
- Cache matches for 24 hours to reduce computation, invalidate when sponsor updates profile
- Compatibility reasons should be human-readable and specific (not just "good match")

### Parallel Opportunities

- All scoring component implementations (T061-T065) can be developed in parallel
- Mobile UI (T070-T072) can be built while algorithm is being implemented (use mock data initially)
- Match card component (T071) and profile screen (T072) are independent

### Dependencies

- Depends on WP02 (database schema) and WP03 (user profiles exist)

### Risks & Mitigations

- **Risk**: Matching algorithm performance degradation with large user base
  - **Mitigation**: Index user location (GIST), add caching layer, paginate sponsor search
- **Risk**: Poor match quality leading to low connection rates
  - **Mitigation**: A/B test scoring weights, gather user feedback on match quality

---

## Work Package WP05: Connection Requests & Management (Priority: P1) ðŸŽ¯ MVP Core

**Goal**: Implement connection request flow (sponsee sends request, sponsor accepts/declines, connection becomes active).
**Independent Test**: Sponsee can send connection request with intro message, sponsor receives notification and can accept/decline/message, accepted connections appear on both dashboards.
**Prompt**: `/tasks/planned/WP05-connection-requests-and-management.md`

### Included Subtasks

- [ ] T075 Create connection request API slice in `mobile/src/store/api/connectionApi.ts` (sendRequest, acceptRequest, declineRequest, getRequests)
- [ ] T076 Implement send connection request screen in `mobile/src/screens/matching/SendRequestScreen.tsx` (introduction message input)
- [ ] T077 [P] Create sponsor pending requests screen in `mobile/src/screens/sponsor/PendingRequestsScreen.tsx` (list of requests)
- [ ] T078 [P] Create connection request detail screen in `mobile/src/screens/sponsor/RequestDetailScreen.tsx` (sponsee profile, intro message, accept/decline/message actions)
- [ ] T079 Implement connection management API endpoints: disconnect, update status
- [ ] T080 [P] Create connections list screen in `mobile/src/screens/connections/ConnectionsScreen.tsx` (active connections for both sponsor and sponsee)
- [ ] T081 [P] Create connection detail screen in `mobile/src/screens/connections/ConnectionDetailScreen.tsx` (connection stats, last contact, disconnect option)
- [ ] T082 Implement notification for new connection requests (sponsor receives push notification)
- [ ] T083 [P] Implement notification for request accepted/declined (sponsee receives notification)
- [ ] T084 Create pending request status indicator on matches screen (show "Pending", "Accepted", "Declined")
- [ ] T085 Implement capacity warning for sponsors approaching max capacity
- [ ] T086 Create connection request expiration job in `supabase/functions/scheduled-tasks/expire-requests.ts` (mark as expired after 30 days)

### Implementation Notes

- Connection request workflow: Sponsee sends â†’ Sponsor reviews â†’ Accept creates active connection OR Decline with optional reason
- Introduction message limited to 500 characters (validate both client and server side)
- Sponsor can message sponsee before deciding (creates pending message thread)
- Multiple concurrent requests allowed (sponsee can send to multiple sponsors)
- Connection status: pending â†’ active (on accept) OR pending â†’ declined (on decline)
- Sponsor capacity incremented on accept, decremented on disconnect (database trigger handles this)

### Parallel Opportunities

- All screen implementations (T076-T081) can be built in parallel
- Notification handlers (T082-T083) can be implemented concurrently
- Scheduled task (T086) is independent of UI work

### Dependencies

- Depends on WP02 (database schema), WP03 (user profiles), WP04 (matching to find sponsors)

### Risks & Mitigations

- **Risk**: Spam requests overwhelming sponsors
  - **Mitigation**: Rate limit requests per sponsee (max 5 pending requests at once)
- **Risk**: Capacity management bugs causing over-commitment
  - **Mitigation**: Database trigger ensures capacity tracking accuracy, add validation in Edge Function

---

## Work Package WP06: Sobriety Tracking & Milestones (Priority: P2)

**Goal**: Implement sobriety date tracking, relapse logging, milestone celebrations with mutual visibility between sponsor and sponsee.
**Independent Test**: Users can add sobriety dates, log relapses, view days sober and milestones. Connected sponsor/sponsee can see each other's sobriety tracking. Milestone notifications sent automatically.
**Prompt**: `/tasks/planned/WP06-sobriety-tracking-and-milestones.md`

### Included Subtasks

- [ ] T087 Create sobriety tracking API slice in `mobile/src/store/api/sobrietyApi.ts` (addSobrietyDate, logRelapse, getSobrietyDates, getMilestones)
- [ ] T088 Implement sobriety tracking screen in `mobile/src/screens/sobriety/SobrietyTrackingScreen.tsx` (current streak, milestone countdown, relapse history)
- [ ] T089 [P] Create add sobriety date screen in `mobile/src/screens/sobriety/AddSobrietyDateScreen.tsx` (substance type, start date picker)
- [ ] T090 [P] Create log relapse screen in `mobile/src/screens/sobriety/LogRelapseScreen.tsx` (date picker, optional private note)
- [ ] T091 [P] Create sobriety calendar component in `mobile/src/components/sobriety/SobrietyCalendar.tsx` (visual timeline with milestones)
- [ ] T092 [P] Create milestone card component in `mobile/src/components/sobriety/MilestoneCard.tsx` (30, 60, 90 days, 6 months, 1 year)
- [ ] T093 Implement days sober calculation (database GENERATED column handles this, surface in UI)
- [ ] T094 Create milestone notification job in `supabase/functions/scheduled-tasks/check-milestones.ts` (daily cron, checks for users reaching milestones)
- [ ] T095 [P] Implement relapse notification for sponsors in `mobile/src/services/notifications.ts`
- [ ] T096 [P] Create mutual sobriety visibility component in `mobile/src/components/connections/MutualSobrietyView.tsx` (show connected user's sobriety)
- [ ] T097 Add sobriety tracking to sponsor and sponsee dashboards
- [ ] T098 Implement relapse private note filtering (ensure sponsors cannot see private notes in RLS policy and API)

### Implementation Notes

- Sobriety dates are independent per substance type (alcohol, drugs, gambling, etc.)
- Milestones: 30, 60, 90, 180, 365 days (calculated fields in database)
- Relapse resets sobriety date, creates new relapse record with optional private note
- Sponsors notified of relapse event but NOT private note (RLS policy enforces this)
- Milestone check runs daily at midnight UTC, sends notifications for users reaching milestones that day
- Mutual visibility: connected sponsor and sponsee can both see each other's sobriety dates and milestones

### Parallel Opportunities

- All screen implementations (T088-T090) can be built in parallel
- Components (T091-T092, T096) can be developed concurrently
- Milestone job (T094) and notification logic (T095) can be implemented independently

### Dependencies

- Depends on WP02 (database schema), WP03 (user profiles), WP05 (connections to enable mutual visibility)

### Risks & Mitigations

- **Risk**: Private relapse notes accidentally exposed to sponsors
  - **Mitigation**: RLS policy explicitly blocks private_note column for sponsors, add integration test
- **Risk**: Milestone notifications sent late or missed
  - **Mitigation**: Use Supabase Edge Function cron job (pg_cron), add monitoring for job execution

---

## Work Package WP07: 12-Step Program Worksheets (Priority: P2)

**Goal**: Implement digital 12-step worksheets with sponsee responses, sponsor comments, custom questions, and step completion tracking.
**Independent Test**: Sponsee can view step worksheets, write responses, see sponsor comments. Sponsor can review step work, add comments, customize questions, mark steps complete. Progress tracked on dashboards.
**Prompt**: `/tasks/planned/WP07-twelve-step-program-worksheets.md`

### Included Subtasks

- [ ] T099 Create step work API slice in `mobile/src/store/api/stepWorkApi.ts` (getSteps, getStepWork, saveResponses, addComment, markComplete, customizeQuestions)
- [ ] T100 Implement 12-step overview screen in `mobile/src/screens/stepwork/StepsOverviewScreen.tsx` (list of 12 steps with completion status)
- [ ] T101 [P] Create step worksheet screen in `mobile/src/screens/stepwork/StepWorksheetScreen.tsx` (questions, response inputs, sponsor comments)
- [ ] T102 [P] Create sponsor step review screen in `mobile/src/screens/sponsor/StepReviewScreen.tsx` (view sponsee responses, add comments, mark complete)
- [ ] T103 [P] Implement step question component in `mobile/src/components/stepwork/StepQuestion.tsx` (question text, response text area, sponsor comment display)
- [ ] T104 [P] Create sponsor comment component in `mobile/src/components/stepwork/SponsorComment.tsx` (comment text, timestamp, edit/delete)
- [ ] T105 Implement auto-save for step work responses (debounced save every 5 seconds)
- [ ] T106 [P] Create custom question modal in `mobile/src/components/stepwork/CustomQuestionModal.tsx` (sponsor adds/edits questions)
- [ ] T107 Implement step completion logic (sponsor marks complete, status updates, next step unlocks)
- [ ] T108 [P] Add step progress indicator to sponsor dashboard (show all sponsees' step progress)
- [ ] T109 [P] Add step progress indicator to sponsee dashboard (show current step, % complete)
- [ ] T110 Create step work notification for sponsees when sponsor adds comments
- [ ] T111 Implement step work preservation on disconnection (archived for 90 days, user's own work preserved indefinitely)

### Implementation Notes

- Steps table is pre-seeded reference data with default questions
- step_work table stores responses as JSONB: `[{question_id, question_text, answer_text}]`
- Sponsor comments stored as JSONB: `[{question_id, comment_text, commented_at}]`
- Custom questions added per sponsee (stored in step_work.custom_questions JSONB)
- Auto-save prevents data loss if app crashes or network drops
- Only connected sponsors can view/comment on sponsee's step work (RLS policy enforces)

### Parallel Opportunities

- All screen implementations (T100-T102) can be built in parallel
- Components (T103-T104, T106) can be developed concurrently
- Auto-save logic (T105) can be implemented independently
- Dashboard indicators (T108-T109) can be built in parallel

### Dependencies

- Depends on WP02 (database schema with steps and step_work tables), WP05 (active connections required)

### Risks & Mitigations

- **Risk**: Data loss if auto-save fails
  - **Mitigation**: Debounced auto-save + manual save button, persist draft in AsyncStorage as backup
- **Risk**: Sponsor comments not immediately visible to sponsee
  - **Mitigation**: Use Realtime subscription to step_work table, push update to sponsee's UI instantly

---

## Work Package WP08: Messaging & Structured Check-Ins (Priority: P2)

**Goal**: Implement in-app text messaging, structured check-in scheduling, and optional external contact sharing.
**Independent Test**: Connected users can send/receive messages with push notifications. Sponsors can schedule recurring check-ins, sponsees receive prompts and respond. Message history persists.
**Prompt**: `/tasks/planned/WP08-messaging-and-structured-checkins.md`

### Included Subtasks

- [ ] T112 Create messaging API slice in `mobile/src/store/api/messagingApi.ts` (sendMessage, getMessages, markRead, getConversations)
- [ ] T113 Implement conversations list screen in `mobile/src/screens/messaging/ConversationsScreen.tsx` (threads with unread indicators)
- [ ] T114 [P] Create conversation thread screen in `mobile/src/screens/messaging/ConversationScreen.tsx` (message list, input, send button)
- [ ] T115 [P] Create message bubble component in `mobile/src/components/messaging/MessageBubble.tsx` (sender/recipient styling, timestamp, read status)
- [ ] T116 Implement real-time message delivery using Supabase Realtime subscriptions in `mobile/src/services/realtime.ts`
- [ ] T117 [P] Create check-in API slice in `mobile/src/store/api/checkinApi.ts` (createCheckIn, updateCheckIn, respondToCheckIn, getCheckIns)
- [ ] T118 [P] Create schedule check-in screen in `mobile/src/screens/sponsor/ScheduleCheckInScreen.tsx` (frequency, questions, time picker)
- [ ] T119 [P] Create check-in response screen in `mobile/src/screens/messaging/CheckInResponseScreen.tsx` (questions, answer inputs, submit)
- [ ] T120 Implement check-in notification job in `supabase/functions/scheduled-tasks/send-checkin-reminders.ts` (cron job checks scheduled check-ins)
- [ ] T121 [P] Create check-in history component in `mobile/src/components/messaging/CheckInHistory.tsx` (past responses, completion rate)
- [ ] T122 Implement missed check-in detection (3 missed = notify sponsor)
- [ ] T123 [P] Add external contact sharing toggle in sponsor profile settings
- [ ] T124 [P] Display external contact info (phone, email) on sponsor profile for connected sponsees
- [ ] T125 Implement message push notifications using FCM
- [ ] T126 Add message pagination (fetch 50 messages at a time, infinite scroll)

### Implementation Notes

- Messages stored in messages table with connection_id, sender_id, recipient_id
- Realtime subscriptions use PostgreSQL LISTEN/NOTIFY via Supabase Realtime
- Check-ins are scheduled with recurrence (daily, weekly, custom interval)
- Check-in questions stored as JSONB array in checkins table
- Responses stored in checkin_responses table, linked to specific check-in and connection
- External contact (phone, email) only visible to connected sponsees, opt-in by sponsor
- Message delivery target: <5 seconds under normal network (3G+)

### Parallel Opportunities

- All screen implementations (T113-T114, T118-T119) can be built in parallel
- Components (T115, T121) can be developed concurrently
- Realtime service (T116) and API slices (T112, T117) can be implemented independently
- Check-in job (T120) is separate from UI work
- External contact features (T123-T124) can be built in parallel

### Dependencies

- Depends on WP02 (database schema), WP05 (active connections required for messaging)

### Risks & Mitigations

- **Risk**: Message delivery failures or delays
  - **Mitigation**: Implement retry logic with exponential backoff, show send status in UI
- **Risk**: Realtime subscription connection drops
  - **Mitigation**: Reconnect logic in realtime service, poll for new messages on app resume

---

## Work Package WP09: Push Notifications & Real-Time Updates (Priority: P2) ðŸ”” Cross-Cutting

**Goal**: Implement push notification system for all critical events and real-time UI updates via Supabase Realtime.
**Independent Test**: Users receive push notifications for connection requests, messages, milestones, relapses (90%+ delivery rate). Real-time updates appear instantly without app refresh.
**Prompt**: `/tasks/planned/WP09-push-notifications-and-realtime-updates.md`

### Included Subtasks

- [ ] T127 Configure Firebase Cloud Messaging in Firebase Console (iOS APNs certificate, Android FCM setup)
- [ ] T128 [P] Install and configure react-native-firebase in mobile app
- [ ] T129 Implement FCM token registration in `mobile/src/services/notifications.ts` (store token in users.fcm_token)
- [ ] T130 [P] Create notification API slice in `mobile/src/store/api/notificationApi.ts` (getNotifications, markRead, updatePreferences)
- [ ] T131 [P] Implement notification preferences screen in `mobile/src/screens/settings/NotificationPreferencesScreen.tsx` (toggle notification types, quiet hours)
- [ ] T132 Create push notification handler in `mobile/src/services/pushNotificationHandler.ts` (foreground, background, quit state)
- [ ] T133 [P] Create notification dispatch Edge Function in `supabase/functions/notifications/send-push.ts` (send via FCM API)
- [ ] T134 Implement notification triggers for connection requests (INSERT on connection_requests â†’ send to sponsor)
- [ ] T135 [P] Implement notification triggers for request accepted/declined (UPDATE on connection_requests â†’ send to sponsee)
- [ ] T136 [P] Implement notification triggers for new messages (INSERT on messages â†’ send to recipient)
- [ ] T137 [P] Implement notification triggers for milestone celebrations (milestone job â†’ send to user and connected sponsors/sponsees)
- [ ] T138 [P] Implement notification triggers for relapse alerts (INSERT on relapses â†’ send to connected sponsors)
- [ ] T139 [P] Implement notification triggers for check-in reminders (check-in job â†’ send to sponsee)
- [ ] T140 Create in-app notification center screen in `mobile/src/screens/notifications/NotificationCenterScreen.tsx` (list of recent notifications)
- [ ] T141 [P] Add notification badge to tab bar (unread count)
- [ ] T142 Implement deep linking from notifications to relevant screens (use React Navigation deep links)
- [ ] T143 Setup Realtime subscriptions for connection-specific channels in `mobile/src/services/realtime.ts`
- [ ] T144 [P] Implement Realtime listener for new messages (update UI instantly without refetch)
- [ ] T145 [P] Implement Realtime listener for step work updates (sponsor comments appear instantly for sponsee)
- [ ] T146 Add notification delivery monitoring and logging in Edge Function

### Implementation Notes

- FCM handles both iOS (APNs) and Android push notifications
- Store FCM token in users table on app launch/token refresh
- Notification types: connection_request, request_accepted, request_declined, new_message, checkin_reminder, milestone, relapse_alert
- Push notifications sent via Edge Function calling FCM REST API
- Quiet hours setting prevents notifications during user-specified time range
- Deep links use URL scheme `volvoxsober://` to open specific screens
- Realtime subscriptions use connection-specific channels to reduce bandwidth

### Parallel Opportunities

- FCM setup (T127-T129) can proceed while notification logic is being built
- All notification trigger implementations (T134-T139) can be developed in parallel
- UI components (T131, T140-T141) can be built concurrently
- Realtime subscriptions (T143-T145) can be implemented independently

### Dependencies

- Depends on WP02 (database schema), WP05 (connections), WP08 (messaging for message notifications)

### Risks & Mitigations

- **Risk**: Push notification delivery failures (< 90% delivery rate)
  - **Mitigation**: Retry failed sends, monitor FCM API errors, validate tokens before sending
- **Risk**: Notification spam overwhelming users
  - **Mitigation**: Implement notification preferences, respect quiet hours, batch similar notifications

---

## Work Package WP10: Dark Mode & Accessibility (Priority: P3)

**Goal**: Implement light/dark theme support with WCAG AA contrast compliance and accessibility features.
**Independent Test**: Users can toggle theme, all screens render correctly in both modes with 4.5:1 contrast ratios. Screen readers work correctly. Theme persists across sessions.
**Prompt**: `/tasks/planned/WP10-dark-mode-and-accessibility.md`

### Included Subtasks

- [ ] T147 Configure React Native Paper theme with light and dark color schemes in `mobile/src/theme/theme.ts`
- [ ] T148 [P] Define color tokens meeting WCAG AA standards (4.5:1 contrast) for both themes
- [ ] T149 Implement theme selection in settings screen (light, dark, system default)
- [ ] T150 [P] Create theme persistence using AsyncStorage
- [ ] T151 [P] Setup theme provider in `mobile/App.tsx` wrapping navigation
- [ ] T152 Implement system theme detection (listen to device appearance changes)
- [ ] T153 [P] Audit all screens for theme compliance (no hard-coded colors)
- [ ] T154 [P] Update all components to use theme tokens from React Native Paper
- [ ] T155 [P] Add accessibility labels to all interactive elements (buttons, inputs, touchables)
- [ ] T156 [P] Implement dynamic font sizing support (respects device text size settings)
- [ ] T157 [P] Ensure touch targets meet minimum size (44x44pt iOS, 48x48dp Android)
- [ ] T158 Test with iOS VoiceOver and Android TalkBack screen readers
- [ ] T159 Add focus indicators for keyboard navigation (iPad, Android with keyboard)
- [ ] T160 Run automated accessibility audit using Detox accessibility helpers

### Implementation Notes

- React Native Paper provides built-in theming system
- Store theme preference in AsyncStorage, load on app launch
- System theme detection uses `react-native`'s `useColorScheme` hook
- All colors must use theme tokens, never hard-coded hex values
- Accessibility labels use `accessibilityLabel` and `accessibilityHint` props
- Font scaling uses `PixelRatio.getFontScale()` or rely on Paper's responsive typography
- Touch targets: minimum 44x44pt (iOS) or 48x48dp (Android) for all tappable elements

### Parallel Opportunities

- Theme definition (T147-T148) can proceed independently
- Theme implementation (T149-T152) can be built while auditing screens
- Accessibility work (T155-T160) can be done in parallel with theme rollout

### Dependencies

- Depends on WP01 (React Native Paper configured), all UI screens implemented

### Risks & Mitigations

- **Risk**: Contrast failures in dark mode
  - **Mitigation**: Use automated contrast checker tools, manual visual testing on real devices
- **Risk**: Hard-coded colors breaking theme switching
  - **Mitigation**: ESLint rule to block hard-coded color strings, enforce theme token usage

---

## Dependency & Execution Summary

### Sequence

```
WP01 (Setup)
  â†’ WP02 (Database & Auth Foundation)
    â†’ WP03 (User Onboarding & Profiles)
      â†’ WP04 (Matching Algorithm) [P1 MVP]
      â†’ WP05 (Connection Requests) [P1 MVP]
        â†’ WP06 (Sobriety Tracking) [P2]
        â†’ WP07 (12-Step Worksheets) [P2]
        â†’ WP08 (Messaging & Check-Ins) [P2]
        â†’ WP09 (Notifications & Realtime) [P2 Cross-Cutting]
      â†’ WP10 (Dark Mode & Accessibility) [P3]
```

### Parallelization

- **After WP03 completes**: WP04 and WP05 can proceed in parallel (both require profiles but are independent features)
- **After WP05 completes**: WP06, WP07, WP08 can proceed in parallel (all require connections but are independent)
- **WP09 can start after WP05**: Notification infrastructure can be built while other features are in progress
- **WP10 can start early**: Theme work can begin once WP01 completes, applied iteratively as screens are built

### MVP Scope (Minimal Viable Product)

**Minimum Release**: WP01 + WP02 + WP03 + WP04 + WP05

- Users can signup, create profiles, find sponsor matches, send/accept connection requests
- This delivers the core matching and connection value proposition
- Estimated implementation: 4-6 weeks with 2 developers

**Full P1+P2 Release**: Add WP06 + WP07 + WP08 + WP09

- Complete recovery platform with sobriety tracking, step work, messaging, notifications
- Estimated implementation: 8-12 weeks with 2-3 developers

**Polish Release**: Add WP10

- Accessibility and theme enhancements
- Estimated implementation: +2 weeks

---

## Subtask Index (Reference)

| Subtask ID | Summary                                       | Work Package | Priority | Parallel? |
| ---------- | --------------------------------------------- | ------------ | -------- | --------- |
| T001       | Create root workspace and package.json        | WP01         | P0       | No        |
| T002       | Initialize React Native project               | WP01         | P0       | Yes       |
| T003       | Initialize Supabase project                   | WP01         | P0       | Yes       |
| T004       | Install mobile dependencies                   | WP01         | P0       | Yes       |
| T005       | Configure ESLint and Prettier                 | WP01         | P0       | Yes       |
| T006       | Configure TypeScript tsconfig                 | WP01         | P0       | Yes       |
| T007       | Setup Jest and React Native Testing Library   | WP01         | P0       | Yes       |
| T008       | Configure Detox for E2E testing               | WP01         | P0       | Yes       |
| T009       | Create shared types directory                 | WP01         | P0       | No        |
| T010       | Setup Firebase Cloud Messaging config         | WP01         | P0       | Yes       |
| T011       | Configure React Native Paper theme            | WP01         | P0       | Yes       |
| T012       | Document local development setup              | WP01         | P0       | No        |
| T013       | Create .env.example files                     | WP01         | P0       | No        |
| T014       | Create users table migration                  | WP02         | P0       | No        |
| T015       | Create sponsor/sponsee profiles migrations    | WP02         | P0       | Yes       |
| T016       | Create sobriety_dates and relapses migrations | WP02         | P0       | Yes       |
| T017       | Create connection management migrations       | WP02         | P0       | Yes       |
| T018       | Create steps and step_work migrations         | WP02         | P0       | Yes       |
| T019       | Create messaging migrations                   | WP02         | P0       | Yes       |
| T020       | Create notifications migration                | WP02         | P0       | Yes       |
| T021       | Create RLS policies for users and profiles    | WP02         | P0       | No        |
| T022       | Create RLS policies for sobriety tracking     | WP02         | P0       | Yes       |
| T023       | Create RLS policies for connections           | WP02         | P0       | Yes       |
| T024       | Create RLS policies for step work             | WP02         | P0       | Yes       |
| T025       | Create RLS policies for messaging             | WP02         | P0       | Yes       |
| T026       | Create RLS policies for notifications         | WP02         | P0       | Yes       |
| T027       | Create update_updated_at trigger              | WP02         | P0       | No        |
| T028       | Create notify_new_message trigger             | WP02         | P0       | Yes       |
| T029       | Create update_connection_last_contact trigger | WP02         | P0       | Yes       |
| T030       | Create update_sponsor_capacity trigger        | WP02         | P0       | Yes       |
| T031       | Create indexes on users table                 | WP02         | P0       | No        |
| T032       | Create indexes on profile tables              | WP02         | P0       | Yes       |
| T033       | Create indexes on sobriety tables             | WP02         | P0       | Yes       |
| T034       | Create indexes on connection tables           | WP02         | P0       | Yes       |
| T035       | Create indexes on messages table              | WP02         | P0       | Yes       |
| T036       | Create indexes on checkin tables              | WP02         | P0       | Yes       |
| T037       | Create indexes on notifications table         | WP02         | P0       | Yes       |
| T038       | Create seed data for 12 AA steps              | WP02         | P0       | No        |
| T039       | Implement Supabase client config              | WP02         | P0       | No        |
| T040       | Setup Redux store with RTK Query              | WP02         | P0       | Yes       |
| T041       | Create authentication API slice               | WP02         | P0       | No        |
| T042       | Create auth screens                           | WP02         | P0       | No        |
| T043       | Implement secure token storage                | WP02         | P0       | Yes       |
| T044       | Write RLS policy tests                        | WP02         | P0       | No        |
| T045       | Create onboarding navigation flow             | WP03         | P1       | No        |
| T046       | Implement role selection screen               | WP03         | P1       | No        |
| T047       | Create profile form screen                    | WP03         | P1       | Yes       |
| T048       | Create sponsee preferences screen             | WP03         | P1       | Yes       |
| T049       | Create sponsor preferences screen             | WP03         | P1       | Yes       |
| T050       | Create sobriety date input screen             | WP03         | P1       | Yes       |
| T051       | Implement user profile API slice              | WP03         | P1       | No        |
| T052       | Implement sponsor profile API slice           | WP03         | P1       | Yes       |
| T053       | Implement sponsee profile API slice           | WP03         | P1       | Yes       |
| T054       | Implement sobriety date API slice             | WP03         | P1       | Yes       |
| T055       | Create profile editing screen                 | WP03         | P1       | No        |
| T056       | Create profile photo upload component         | WP03         | P1       | Yes       |
| T057       | Create location picker component              | WP03         | P1       | Yes       |
| T058       | Implement onboarding Redux slice              | WP03         | P1       | No        |
| T059       | Create shared profile types                   | WP03         | P1       | No        |
| T060       | Create matching algorithm Edge Function       | WP04         | P1       | No        |
| T061       | Implement geographic proximity scoring        | WP04         | P1       | No        |
| T062       | Implement sobriety alignment scoring          | WP04         | P1       | Yes       |
| T063       | Implement communication alignment scoring     | WP04         | P1       | Yes       |
| T064       | Implement demographic preference scoring      | WP04         | P1       | Yes       |
| T065       | Implement availability scoring                | WP04         | P1       | Yes       |
| T066       | Generate compatibility reasons array          | WP04         | P1       | No        |
| T067       | Cache match results in matches table          | WP04         | P1       | No        |
| T068       | Implement match invalidation                  | WP04         | P1       | No        |
| T069       | Create matching API slice                     | WP04         | P1       | No        |
| T070       | Implement matches screen                      | WP04         | P1       | No        |
| T071       | Create sponsor match card component           | WP04         | P1       | Yes       |
| T072       | Create sponsor profile detail screen          | WP04         | P1       | Yes       |
| T073       | Implement match refresh logic                 | WP04         | P1       | No        |
| T074       | Add loading and empty states                  | WP04         | P1       | No        |
| T075       | Create connection request API slice           | WP05         | P1       | No        |
| T076       | Implement send request screen                 | WP05         | P1       | No        |
| T077       | Create sponsor pending requests screen        | WP05         | P1       | Yes       |
| T078       | Create request detail screen                  | WP05         | P1       | Yes       |
| T079       | Implement connection management API           | WP05         | P1       | No        |
| T080       | Create connections list screen                | WP05         | P1       | Yes       |
| T081       | Create connection detail screen               | WP05         | P1       | Yes       |
| T082       | Implement new request notification            | WP05         | P1       | Yes       |
| T083       | Implement request response notification       | WP05         | P1       | Yes       |
| T084       | Create request status indicator               | WP05         | P1       | No        |
| T085       | Implement capacity warning                    | WP05         | P1       | No        |
| T086       | Create request expiration job                 | WP05         | P1       | No        |
| T087       | Create sobriety tracking API slice            | WP06         | P2       | No        |
| T088       | Implement sobriety tracking screen            | WP06         | P2       | No        |
| T089       | Create add sobriety date screen               | WP06         | P2       | Yes       |
| T090       | Create log relapse screen                     | WP06         | P2       | Yes       |
| T091       | Create sobriety calendar component            | WP06         | P2       | Yes       |
| T092       | Create milestone card component               | WP06         | P2       | Yes       |
| T093       | Implement days sober calculation              | WP06         | P2       | No        |
| T094       | Create milestone notification job             | WP06         | P2       | No        |
| T095       | Implement relapse notification                | WP06         | P2       | Yes       |
| T096       | Create mutual sobriety view component         | WP06         | P2       | Yes       |
| T097       | Add sobriety tracking to dashboards           | WP06         | P2       | No        |
| T098       | Implement private note filtering              | WP06         | P2       | No        |
| T099       | Create step work API slice                    | WP07         | P2       | No        |
| T100       | Implement steps overview screen               | WP07         | P2       | No        |
| T101       | Create step worksheet screen                  | WP07         | P2       | Yes       |
| T102       | Create sponsor step review screen             | WP07         | P2       | Yes       |
| T103       | Implement step question component             | WP07         | P2       | Yes       |
| T104       | Create sponsor comment component              | WP07         | P2       | Yes       |
| T105       | Implement auto-save for responses             | WP07         | P2       | No        |
| T106       | Create custom question modal                  | WP07         | P2       | Yes       |
| T107       | Implement step completion logic               | WP07         | P2       | No        |
| T108       | Add step progress to sponsor dashboard        | WP07         | P2       | Yes       |
| T109       | Add step progress to sponsee dashboard        | WP07         | P2       | Yes       |
| T110       | Create step work comment notification         | WP07         | P2       | No        |
| T111       | Implement step work preservation              | WP07         | P2       | No        |
| T112       | Create messaging API slice                    | WP08         | P2       | No        |
| T113       | Implement conversations list screen           | WP08         | P2       | No        |
| T114       | Create conversation thread screen             | WP08         | P2       | Yes       |
| T115       | Create message bubble component               | WP08         | P2       | Yes       |
| T116       | Implement Realtime message delivery           | WP08         | P2       | No        |
| T117       | Create check-in API slice                     | WP08         | P2       | Yes       |
| T118       | Create schedule check-in screen               | WP08         | P2       | Yes       |
| T119       | Create check-in response screen               | WP08         | P2       | Yes       |
| T120       | Implement check-in notification job           | WP08         | P2       | No        |
| T121       | Create check-in history component             | WP08         | P2       | Yes       |
| T122       | Implement missed check-in detection           | WP08         | P2       | No        |
| T123       | Add external contact sharing toggle           | WP08         | P2       | Yes       |
| T124       | Display external contact info                 | WP08         | P2       | Yes       |
| T125       | Implement message push notifications          | WP08         | P2       | No        |
| T126       | Add message pagination                        | WP08         | P2       | No        |
| T127       | Configure Firebase Cloud Messaging            | WP09         | P2       | No        |
| T128       | Install react-native-firebase                 | WP09         | P2       | Yes       |
| T129       | Implement FCM token registration              | WP09         | P2       | No        |
| T130       | Create notification API slice                 | WP09         | P2       | Yes       |
| T131       | Implement notification preferences screen     | WP09         | P2       | Yes       |
| T132       | Create push notification handler              | WP09         | P2       | No        |
| T133       | Create notification dispatch Edge Function    | WP09         | P2       | Yes       |
| T134       | Implement connection request notifications    | WP09         | P2       | No        |
| T135       | Implement request response notifications      | WP09         | P2       | Yes       |
| T136       | Implement new message notifications           | WP09         | P2       | Yes       |
| T137       | Implement milestone notifications             | WP09         | P2       | Yes       |
| T138       | Implement relapse alert notifications         | WP09         | P2       | Yes       |
| T139       | Implement check-in reminder notifications     | WP09         | P2       | Yes       |
| T140       | Create notification center screen             | WP09         | P2       | No        |
| T141       | Add notification badge to tab bar             | WP09         | P2       | Yes       |
| T142       | Implement deep linking                        | WP09         | P2       | No        |
| T143       | Setup Realtime subscriptions                  | WP09         | P2       | No        |
| T144       | Implement Realtime message listener           | WP09         | P2       | Yes       |
| T145       | Implement Realtime step work listener         | WP09         | P2       | Yes       |
| T146       | Add notification delivery monitoring          | WP09         | P2       | No        |
| T147       | Configure React Native Paper themes           | WP10         | P3       | No        |
| T148       | Define WCAG AA color tokens                   | WP10         | P3       | Yes       |
| T149       | Implement theme selection in settings         | WP10         | P3       | No        |
| T150       | Create theme persistence                      | WP10         | P3       | Yes       |
| T151       | Setup theme provider                          | WP10         | P3       | Yes       |
| T152       | Implement system theme detection              | WP10         | P3       | No        |
| T153       | Audit screens for theme compliance            | WP10         | P3       | Yes       |
| T154       | Update components to use theme tokens         | WP10         | P3       | Yes       |
| T155       | Add accessibility labels                      | WP10         | P3       | Yes       |
| T156       | Implement dynamic font sizing                 | WP10         | P3       | Yes       |
| T157       | Ensure touch target sizes                     | WP10         | P3       | Yes       |
| T158       | Test with screen readers                      | WP10         | P3       | No        |
| T159       | Add focus indicators                          | WP10         | P3       | No        |
| T160       | Run automated accessibility audit             | WP10         | P3       | No        |

---

**Total Subtasks**: 160
**Total Work Packages**: 10
**Estimated Timeline**: 10-14 weeks with 2-3 developers
**MVP Scope**: WP01-WP05 (5 packages, ~60 subtasks, 4-6 weeks)
