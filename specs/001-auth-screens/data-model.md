# Data Model: Authentication Screens

**Branch**: `001-auth-screens` | **Date**: 2025-11-04 | **Spec**: [spec.md](./spec.md)

## Overview

This document defines the data entities, fields, and relationships for the authentication feature. All authentication data is managed by Supabase Auth (GoTrue), which provides built-in tables and token management. This feature does NOT create custom database tables - it leverages Supabase's existing auth infrastructure.

## Entities

### User Account (Managed by Supabase Auth)

**Table**: `auth.users` (Supabase system table)
**Description**: Represents a registered user in the authentication system. Managed entirely by Supabase Auth - no custom table creation needed.

**Fields**:

| Field | Type | Required | Validation | Default | Description |
|-------|------|----------|------------|---------|-------------|
| `id` | UUID | Yes | Auto-generated | UUID v4 | Primary key, auto-generated by Supabase |
| `email` | String | Yes | Valid email format, unique | - | User's email address (unique identifier) |
| `encrypted_password` | String | Yes | Hashed by Supabase | - | Bcrypt hashed password (never plain text) |
| `email_confirmed_at` | Timestamp | No | ISO 8601 | NULL | When email verification was completed |
| `confirmation_token` | String | No | Secure hash | NULL | Token for email verification (24h expiry) |
| `confirmation_sent_at` | Timestamp | No | ISO 8601 | NULL | When verification email was sent |
| `recovery_token` | String | No | Secure hash | NULL | Token for password reset (24h expiry) |
| `recovery_sent_at` | Timestamp | No | ISO 8601 | NULL | When password reset email was sent |
| `created_at` | Timestamp | Yes | ISO 8601 | NOW() | Account creation timestamp |
| `updated_at` | Timestamp | Yes | ISO 8601 | NOW() | Last modification timestamp |
| `last_sign_in_at` | Timestamp | No | ISO 8601 | NULL | Last successful login timestamp |
| `raw_app_meta_data` | JSONB | No | Valid JSON | {} | App-specific metadata |
| `raw_user_meta_data` | JSONB | No | Valid JSON | {} | User-provided metadata |

**Indexes**:
- Primary key: `id`
- Unique index: `email` (enforces no duplicate accounts)
- Index: `confirmation_token` (for email verification lookup)
- Index: `recovery_token` (for password reset lookup)

**Row Level Security (RLS)**:
- Users can only read their own account data
- Only Supabase Auth service can write to this table
- Public signup enabled via Supabase Auth API

**Relationships**: None (self-contained authentication entity)

**Validation Rules**:
```typescript
// Client-side validation (Yup schema)
const signupSchema = yup.object({
  email: yup
    .string()
    .email('Invalid email format')
    .required('Email is required'),
  password: yup
    .string()
    .min(8, 'Minimum 8 characters required')
    .matches(/[a-zA-Z]/, 'Must contain at least one letter')
    .matches(/[0-9]/, 'Must contain at least one number')
    .required('Password is required')
})

const loginSchema = yup.object({
  email: yup
    .string()
    .email('Invalid email format')
    .required('Email is required'),
  password: yup
    .string()
    .required('Password is required')
})

const passwordResetSchema = yup.object({
  email: yup
    .string()
    .email('Invalid email format')
    .required('Email is required')
})
```

**Server-side validation** (enforced by Supabase Auth):
- Email must be valid format
- Email must be unique (duplicate check)
- Password must meet Supabase Auth requirements (configurable, defaults to 6+ chars)

**Business Rules**:
1. Users with `email_confirmed_at = NULL` cannot access the main application (FR-005)
2. `confirmation_token` expires after 24 hours from `confirmation_sent_at`
3. `recovery_token` expires after 24 hours from `recovery_sent_at` (FR-009)
4. Old passwords are invalidated when `encrypted_password` is updated (FR-003)
5. Email uniqueness enforced at database level (FR-012)

---

### Session Token (Managed by Supabase Auth)

**Storage**: Redux Persist → AsyncStorage (client-side), `auth.sessions` table (server-side)
**Description**: JWT access and refresh tokens for persistent authentication. Managed by Supabase Auth SDK.

**Client-Side Structure** (Redux state):
```typescript
interface AuthState {
  session: {
    access_token: string        // JWT access token (1 hour expiry)
    refresh_token: string        // JWT refresh token (auto-refresh)
    expires_at: number           // Unix timestamp of token expiry
    expires_in: number           // Seconds until expiry
    token_type: 'bearer'         // Always 'bearer' for JWT
  } | null
  user: {
    id: string                   // User UUID
    email: string                // User email
    email_confirmed_at: string | null  // Verification status
    app_metadata: Record<string, any>
    user_metadata: Record<string, any>
  } | null
  loading: boolean               // Auth operation in progress
  error: string | null           // Error message from auth operations
}
```

**Server-Side Table**: `auth.sessions` (Supabase system table)

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | UUID | Yes | Session identifier |
| `user_id` | UUID | Yes | Foreign key to `auth.users.id` |
| `created_at` | Timestamp | Yes | Session creation time |
| `updated_at` | Timestamp | Yes | Last token refresh time |
| `factor_id` | UUID | No | For multi-factor auth (not used in MVP) |
| `aal` | String | No | Authentication Assurance Level |
| `not_after` | Timestamp | No | Session expiry time |

**Token Lifecycle**:
1. **Login**: Supabase returns `{ access_token, refresh_token, expires_in }`
2. **Storage**: Redux Persist saves to AsyncStorage for session persistence (FR-007)
3. **Rehydration**: On app restart, Redux Persist loads tokens from AsyncStorage
4. **Validation**: Supabase SDK validates access token on API calls
5. **Refresh**: SDK automatically refreshes expired access tokens using refresh token
6. **Logout**: Tokens cleared from Redux state and AsyncStorage

**Security**:
- Access tokens expire after 1 hour (Supabase default)
- Refresh tokens rotate on each use (prevents replay attacks)
- Tokens stored in AsyncStorage (secure on mobile devices)
- Tokens transmitted over HTTPS only

---

### Email Verification Token (Managed by Supabase Auth)

**Storage**: `auth.users.confirmation_token` field
**Description**: Temporary token sent in verification email. Auto-managed by Supabase Auth.

**Structure**:
- **Token Value**: Secure hash generated by Supabase Auth
- **Associated Email**: `auth.users.email`
- **Expiration**: 24 hours from `confirmation_sent_at` timestamp
- **Status**: Derived from `email_confirmed_at` (NULL = pending, timestamp = verified)

**Flow**:
1. User signs up → Supabase generates `confirmation_token`
2. Supabase sends verification email with magic link containing token
3. User clicks link → App receives token via deep link
4. App calls Supabase Auth to verify token
5. Supabase sets `email_confirmed_at` timestamp, nullifies `confirmation_token`

**Magic Link Format**:
```
volvoxsober://auth/verify?token=CONFIRMATION_TOKEN&type=signup&redirect_to=/
```

**Edge Cases**:
- Expired token (>24h): Show error, allow resend
- Already verified: Show "Email already verified" message
- Invalid token: Show generic error (security - don't reveal if email exists)

---

### Password Reset Token (Managed by Supabase Auth)

**Storage**: `auth.users.recovery_token` field
**Description**: Temporary token sent in password reset email. Auto-managed by Supabase Auth.

**Structure**:
- **Token Value**: Secure hash generated by Supabase Auth
- **Associated User**: `auth.users.id`
- **Expiration**: 24 hours from `recovery_sent_at` timestamp (FR-009)
- **Usage**: One-time use (nullified after password reset)

**Flow**:
1. User requests password reset → Supabase generates `recovery_token`
2. Supabase sends reset email with magic link containing token
3. User clicks link → App receives token via deep link
4. App shows password reset form with token in state
5. User submits new password → Supabase validates token
6. Supabase updates `encrypted_password`, nullifies `recovery_token`

**Magic Link Format**:
```
volvoxsober://auth/forgot-password?token=RECOVERY_TOKEN&type=recovery
```

**Edge Cases**:
- Expired token (>24h): Show error "This reset link has expired. Please request a new one."
- Already used: Show error "This reset link has already been used. Please request a new one if needed."
- Invalid token: Show generic error (security - don't reveal if email exists, FR-011)

---

## Entity Relationships

```
┌─────────────────┐
│  auth.users     │
│  (Supabase)     │
├─────────────────┤
│ id (PK)         │◄──┐
│ email (UNIQUE)  │   │
│ encrypted_pass  │   │
│ confirmation_   │   │  1:N
│   token         │   │
│ recovery_token  │   │
│ email_confirmed │   │
│ created_at      │   │
│ last_sign_in_at │   │
└─────────────────┘   │
                      │
                      │
                ┌─────┴───────┐
                │ auth.sessions│
                │  (Supabase)  │
                ├──────────────┤
                │ id (PK)      │
                │ user_id (FK) │
                │ created_at   │
                │ updated_at   │
                │ not_after    │
                └──────────────┘
```

**Notes**:
- One user can have multiple sessions (different devices)
- Tokens (confirmation, recovery) are embedded in `auth.users` table
- No custom tables needed - all data managed by Supabase Auth

---

## Data Access Patterns

### Client-Side State (Redux)

**authSlice.ts** structure:
```typescript
interface AuthState {
  session: Session | null      // Supabase session object
  user: User | null            // Supabase user object
  loading: boolean             // Auth operations in progress
  error: string | null         // Error messages
}

// Initial state
const initialState: AuthState = {
  session: null,
  user: null,
  loading: false,
  error: null
}
```

**Redux Persist Configuration**:
```typescript
const persistConfig = {
  key: 'auth',
  storage: AsyncStorage,
  whitelist: ['session', 'user']  // Only persist session and user
  // loading and error are ephemeral, not persisted
}
```

### API Integration Patterns

**authService.ts** (Supabase client wrapper):
```typescript
import { createClient } from '@supabase/supabase-js'

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

export const authService = {
  // Signup with email verification
  async signUp(email: string, password: string) {
    const { data, error } = await supabase.auth.signUp({
      email,
      password,
      options: {
        emailRedirectTo: 'volvoxsober://auth/verify'
      }
    })
    return { data, error }
  },

  // Login
  async signIn(email: string, password: string) {
    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password
    })
    return { data, error }
  },

  // Password reset request
  async resetPasswordRequest(email: string) {
    const { data, error } = await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: 'volvoxsober://auth/forgot-password'
    })
    return { data, error }
  },

  // Update password (after reset)
  async updatePassword(newPassword: string) {
    const { data, error } = await supabase.auth.updateUser({
      password: newPassword
    })
    return { data, error }
  },

  // Logout
  async signOut() {
    const { error } = await supabase.auth.signOut()
    return { error }
  },

  // Get current session
  async getSession() {
    const { data, error } = await supabase.auth.getSession()
    return { data, error }
  },

  // Listen to auth state changes
  onAuthStateChange(callback: (event: string, session: Session | null) => void) {
    return supabase.auth.onAuthStateChange(callback)
  }
}
```

---

## Migration Strategy

**No migrations needed** - Supabase Auth tables (`auth.users`, `auth.sessions`) are automatically created and managed by Supabase.

**Configuration Required** (Supabase Dashboard):
1. Enable email confirmation: Settings → Authentication → Email Confirmations → ON
2. Set confirmation expiry: 24 hours (default)
3. Set password reset expiry: 24 hours (default)
4. Configure email templates: Verification email, Password reset email
5. Set redirect URLs:
   - Email confirmation: `volvoxsober://auth/verify`
   - Password reset: `volvoxsober://auth/forgot-password`

**Deep Link Setup** (app.json):
```json
{
  "expo": {
    "scheme": "volvoxsober",
    "ios": {
      "associatedDomains": ["applinks:volvoxsober.app"]
    },
    "android": {
      "intentFilters": [
        {
          "action": "VIEW",
          "data": [
            { "scheme": "volvoxsober" }
          ],
          "category": ["BROWSABLE", "DEFAULT"]
        }
      ]
    }
  }
}
```

---

## Testing Data

**Test User Accounts** (create via Supabase Dashboard for development):

```sql
-- Test user 1: Verified account
INSERT INTO auth.users (email, encrypted_password, email_confirmed_at)
VALUES ('test@example.com', crypt('Test1234', gen_salt('bf')), NOW());

-- Test user 2: Unverified account
INSERT INTO auth.users (email, encrypted_password, confirmation_sent_at)
VALUES ('unverified@example.com', crypt('Test1234', gen_salt('bf')), NOW());
```

**Note**: In practice, use Supabase Auth API (`signUp`) to create test accounts, not direct SQL inserts.

---

## Security Considerations

1. **Password Storage**: Bcrypt hashed by Supabase (never plain text) - FR-010
2. **Token Security**: All tokens (confirmation, recovery, access) are cryptographically secure hashes
3. **Email Enumeration Prevention**: Generic error messages for password reset (FR-011)
4. **Token Expiry**: 24-hour expiry for email verification and password reset tokens (FR-009)
5. **Session Persistence**: Tokens stored in AsyncStorage (secure on mobile, not accessible to other apps)
6. **HTTPS Only**: All API calls to Supabase over HTTPS
7. **Row Level Security**: Supabase Auth tables have built-in RLS policies

---

## Performance Optimization

1. **Session Rehydration**: Redux Persist loads from AsyncStorage on app start (<100ms)
2. **Token Refresh**: Automatic and transparent (Supabase SDK handles refresh logic)
3. **Offline Resilience**: Session data persists offline, auth calls queue when network restored
4. **Indexes**: Supabase Auth tables pre-indexed for fast email and token lookups

---

## Compliance

- **GDPR**: User can delete account via Supabase Auth API (triggers data deletion)
- **Accessibility**: No data model impact (UI concern, handled by components)
- **Cross-Platform**: Identical data model for iOS, Android, Web (universal)
